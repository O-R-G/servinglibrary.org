<?php 
require_once("_Library/displayMedia.php"); 
require_once("GLOBAL/head.php"); 
?>


	<!-- MAIN -->

<?php


	// Get object plus media
	
	// mySQL query returns two rows with full object details and related media
	// (row 1 PDF, row 2 jpg)
	// (row 3 asterisk video)

	$sql = "SELECT objects.id AS objectsId, objects.name1, objects.deck, objects.body, objects.active, objects.rank as objectsRank, 
			wires.fromid, wires.toid, wires.active, media.id AS mediaId, 
			media.object AS mediaObject, media.type, media.caption, media.active, media.rank 
			FROM objects, wires, media 
			WHERE objects.id = $id 
			AND wires.toid = objects.id 
			AND media.object = objects.id 
			AND objects.active = '1' 
			AND wires.active = '1' 
			AND media.active = '1' 
			ORDER BY media.type DESC 
			LIMIT 3;";

	$result =  MYSQL_QUERY($sql);
	
	// PDF

	$myrow  =  MYSQL_FETCH_ARRAY($result);
	
	if ( $myrow["mediaId"] && $myrow["type"] == "pdf" ) 
	{
		$sourceFile = STR_PAD($myrow["mediaId"], 5, "0", STR_PAD_LEFT);
		if ( $myrow["caption"] ) 
			$downloadFile = $myrow["caption"];
		else 
			$downloadFile = $sourceFile;			
	} 
	else if ( $myrow["mediaId"] && $myrow["type"] == "jpg" ) 
	{
        	$mediaId = $myrow["mediaId"];
	        $type = $myrow["type"];
	        $mediaFile = "MEDIA/". STR_PAD($mediaId, 5, "0", STR_PAD_LEFT) .".". $type;
        	$style  = "width:100%";                 
		$stub   = "<div class='coverContainer'>";
		$stub  .= displayMedia($mediaFile, null, $style);
                $stub  .= "</div>";
mysql_data_seek($result, 0);
	}
	else 
		$error = "Sorry, we are probably uploading this PDF right now. <br />Check back in a few minutes.";
		
	// Cover
	
	$myrow  =  MYSQL_FETCH_ARRAY($result);
	$title = strtoupper($myrow["name1"]);
	$author = $myrow["deck"];
	$body = $myrow["body"];
	$id = $myrow[objectsId];
	$mediaId = $myrow["mediaId"];
	$type = $myrow["type"];
	$mediaFile = "MEDIA/". STR_PAD($mediaId, 5, "0", STR_PAD_LEFT) .".". $type;		
	$style 	= "width:100%";			
	$issue = (int) ($myrow["objectsRank"]);
	
	// Video
	
	$vidRow  =  MYSQL_FETCH_ARRAY($result);
	if ($vidRow) 
		$vidCaption = $vidRow["caption"];
	
	// Display
	
	$html   = "<div class = 'mainContainer'>";	
	$html  .= "<div class='detailContainer issue" . $issue . "'>";

	if ($error)
		$html .= "** " . $error . "**";
	else if ($stub){
		$html  .= $stub;
	}	
	else if ($vidCaption && $watch)
		$html  .= "<div class='videoContainer' style='display:inline-block; vertical-align: top;'>" . $vidCaption . "</div>";
	else 
	{
		$html  .= "<a href = 'download.html?sourceFile=" . $sourceFile . "&downloadFile=" . $downloadFile . "&author=" . $author . "&issue=" . $issue . "' border='0'>";
		$html  .= "<div class='coverContainer'>";

		if ($id == "77066" && !$isMobile) 
		{		
			// G-e-s-t-a-l-t exception
			$html .= "<script>var thisW = 400; var thisH = 570;</script>";
			$html .= "<canvas data-processing-sources='../_Processing/G-e-s-t-a-l-t.pde' width='400' height='570'></canvas>";
		} 
		else
			$html  .= displayMedia($mediaFile, null, $style);
			
		$html  .= "</div>"; // end coverContainer
		$html  .= "</a>";
	}
	
	$html  .= "<div class='captionContainer detail'>". $author . ": " . $title . "	</div>";	
	//$html .= "<a href='index.html'>* Go back *</a>";
	$html  .= "</div>"; // end detailContainer
	$html  .= "<div class='wordsContainer body pad'>";
	$html  .= nl2br($body);
	$html  .= "<br /><br />";
	if (!$stub) 
		$html  .= "<a href = 'download.html?sourceFile=" . $sourceFile . "&downloadFile=" . $downloadFile . "&author=" . $author . "' border='0'>Download PDF</a>";
	if ($vidRow)
		$html .= "<p><a href='" . $pageName . ".html?id=" . $id . "&watch=1'>* Watch VIDEO</a></p>";
	
	$html  .= "</div>";	// end wordsContainer
	$html  .= "</div>"; // end mainContainer						
	
	echo $html;
?>



<?php
require_once("GLOBAL/foot.php"); 
?>
